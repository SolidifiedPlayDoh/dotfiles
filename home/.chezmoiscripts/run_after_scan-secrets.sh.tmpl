#!/bin/bash

# Scan dotfiles and home directory for secrets after chezmoi apply

[ -n "${DEBUG:-}" ] && set -o xtrace
set -o errexit
set -o nounset

# Only run if gitleaks is available
if ! command -v gitleaks >/dev/null 2>&1; then
    echo "⚠️  gitleaks not found, skipping secrets scan"
    echo "   Run 'brew install gitleaks' or './install.sh' to enable scanning"
    exit 0
fi

echo "Scanning dotfiles for secrets..."

# Scan the dotfiles repository (source files in chezmoi working tree)
# Using filesystem mode to scan all files, not just git history
DOTFILES_DIR="{{ .chezmoi.workingTree }}"
if [ -d "$DOTFILES_DIR" ]; then
    gitleaks dir --no-banner -v -l warn "$DOTFILES_DIR"
    gitleaks git --no-banner -v -l warn "$DOTFILES_DIR"
fi

# Scan home directory for common secret files
# Focus on config directories and known secret-prone locations
echo "Scanning: ~/.config for potential secrets"
if [ -d "$HOME/.config" ]; then
    # Only warn, don't fail apply
    gitleaks dir --no-banner -v -l warn "$HOME/.config" --config "$DOTFILES_DIR/.gitleaks.toml" || true
fi
