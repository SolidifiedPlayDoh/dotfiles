#!/bin/bash

# Scan dotfiles and home directory for secrets after chezmoi apply
# Hash: {{ include "dot_Brewfile" | sha256sum }}

[ -n "${DEBUG:-}" ] && set -o xtrace
set -o errexit
set -o nounset

# Only run if trufflehog is available
if ! command -v trufflehog >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  trufflehog not found, skipping secrets scan"
    echo "   Run 'brew install trufflehog' or './install.sh' to enable scanning"
    exit 0
fi

echo "üîç Scanning dotfiles for secrets..."

# Scan the dotfiles repository (source files in chezmoi working tree)
# Using filesystem mode to scan all files, not just git history
DOTFILES_DIR="{{ .chezmoi.workingTree }}"
if [ -d "$DOTFILES_DIR" ]; then
    echo "   Scanning: $DOTFILES_DIR"
    if trufflehog filesystem "$DOTFILES_DIR" --no-update --fail 2>&1 | grep -v "üê∑üîëüê∑"; then
        echo "‚ùå Secrets detected in dotfiles repository!"
        echo "   Review findings above and remove any exposed credentials"
        exit 1
    fi
fi

# Scan home directory for common secret files
# Focus on config directories and known secret-prone locations
echo "   Scanning: ~/.config for potential secrets"
if [ -d "$HOME/.config" ]; then
    # Scan but don't fail - home directory may have legitimate secrets
    # Just warn the user
    if trufflehog filesystem "$HOME/.config" \
        --no-update \
        --exclude-globs="**/.git/**" \
        --exclude-globs="**/node_modules/**" \
        --exclude-globs="**/.cache/**" \
        2>&1 | grep -E "Found (verified|unverified) result"; then
        echo "‚ö†Ô∏è  Potential secrets found in home directory"
        echo "   This is informational - review findings above"
    fi
fi

echo "‚úÖ Dotfiles secrets scan complete"
