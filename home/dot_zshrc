# ============================================================================
# Zsh Configuration
# ============================================================================

# Source zshenv again after macOS /etc/zprofile nukes PATH
source ~/.zshenv

# Stop here if this is e.g. cron or puma-dev (non-interactive)
[[ ! -v TERM ]] && return 0

# ----------------------------------------------------------------------------
# LLM Agent Detection - MUST BE EARLY
# ----------------------------------------------------------------------------
if command -v envsense >/dev/null 2>&1 && envsense check agent >/dev/null 2>&1; then
  export LLM_AGENT_MODE=1
  [[ -f "$XDG_CONFIG_HOME/zsh/llm.zsh" ]] && source "$XDG_CONFIG_HOME/zsh/llm.zsh"
  return  # Skip all human-friendly configuration below
fi

# ----------------------------------------------------------------------------
# Load Znap Plugin Manager
# ----------------------------------------------------------------------------
# Note: Znap is used for caching eval commands only. Plugins are managed by chezmoi.
source ~/.zsh/znap/zsh-snap/znap.zsh

# ----------------------------------------------------------------------------
# Plugins
# ----------------------------------------------------------------------------
# Skip plugins if in LLM agent mode
if [[ -z "${SKIP_ZSH_AUTOSUGGESTIONS:-}" ]]; then
  # Pre-configure zsh-autosuggestions before loading for maximum speed
  export ZSH_AUTOSUGGEST_USE_ASYNC=1
  export ZSH_AUTOSUGGEST_MANUAL_REBIND=1
  export ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
  export ZSH_AUTOSUGGEST_HISTORY_IGNORE="?(#c50,)"  # Ignore commands > 50 chars
  export ZSH_AUTOSUGGEST_COMPLETION_IGNORE="* --help"
  export ZSH_AUTOSUGGEST_STRATEGY=(history completion)

  # Catppuccin theme support - optimized for Ghostty + tmux
  if [[ "${TERM}" == "xterm-ghostty" ]] || [[ -n "${TMUX}" ]]; then
    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=8'
  else
    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=244'
  fi

  # Load zsh-autosuggestions from local path (managed by chezmoi)
  source ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.plugin.zsh

  # Speed hack: only fetch suggestions for commands > 2 chars
  _zsh_autosuggest_should_fetch() {
    (( ${#BUFFER} > 2 ))
  }
fi

# ----------------------------------------------------------------------------
# Completion System
# ----------------------------------------------------------------------------
source "$XDG_CONFIG_HOME/zsh/completions.zsh"

# ----------------------------------------------------------------------------
# Tool Integrations
# ----------------------------------------------------------------------------
source "$XDG_CONFIG_HOME/zsh/tools.zsh"

# ----------------------------------------------------------------------------
# Zsh Options
# ----------------------------------------------------------------------------
# Make delete-by-word stop on punctuation like other editors
WORDCHARS=""

# Case-sensitive completion
CASE_SENSITIVE="true"

# Enable Vi mode for command line editing
bindkey -v

# Vi mode cursor changes
VI_MODE_SET_CURSOR=true

# Cursor shape support for vi mode
function zle-keymap-select {
  if [[ ${KEYMAP} == vicmd ]] || [[ $1 = 'block' ]]; then
    echo -ne '\e[1 q'  # Block cursor
  elif [[ ${KEYMAP} == main ]] || [[ ${KEYMAP} == viins ]] || [[ ${KEYMAP} = '' ]] || [[ $1 = 'beam' ]]; then
    echo -ne '\e[5 q'  # Beam cursor
  fi
}
zle -N zle-keymap-select

# Ensure beam cursor on startup
function zle-line-init {
  echo -ne '\e[5 q'
}
zle -N zle-line-init

# ----------------------------------------------------------------------------
# History Configuration
# ----------------------------------------------------------------------------
HISTFILE="${ZDOTDIR:-$HOME}/.zsh_history"
HISTSIZE=1000000000
SAVEHIST=$HISTSIZE

setopt EXTENDED_HISTORY
setopt SHARE_HISTORY
setopt APPEND_HISTORY
setopt INC_APPEND_HISTORY
setopt HIST_FIND_NO_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY

# ----------------------------------------------------------------------------
# Aliases
# ----------------------------------------------------------------------------
source "$XDG_CONFIG_HOME/zsh/aliases.zsh"

# ----------------------------------------------------------------------------
# OSC 8 Hyperlinks Support
# ----------------------------------------------------------------------------
source "$XDG_CONFIG_HOME/shell/osc8-hyperlinks.sh"

# ----------------------------------------------------------------------------
# Zsh Syntax Highlighting (MUST BE LOADED LAST)
# ----------------------------------------------------------------------------
# Skip syntax highlighting if in LLM agent mode
if [[ -z "${SKIP_ZSH_SYNTAX_HIGHLIGHTING:-}" ]]; then
  # Configure highlighters BEFORE loading
  typeset -gA ZSH_HIGHLIGHT_HIGHLIGHTERS=(
    main 1
    brackets 1
    pattern 1
    cursor 0
    root 0
  )

  export ZSH_HIGHLIGHT_MAXLENGTH=20000

  # Catppuccin-compatible highlighting styles
  typeset -gA ZSH_HIGHLIGHT_STYLES=(
    'builtin'                  'fg=blue'
    'command'                  'fg=green'
    'precommand'               'fg=green,underline'
    'alias'                    'fg=cyan'
    'function'                 'fg=cyan'
    'path'                     'fg=white,underline'
    'path_prefix'              'fg=white'
    'path_approx'              'fg=yellow'
    'single-hyphen-option'     'fg=magenta'
    'double-hyphen-option'     'fg=magenta'
    'single-quoted-argument'   'fg=yellow'
    'double-quoted-argument'   'fg=yellow'
    'dollar-quoted-argument'   'fg=yellow'
    'back-quoted-argument'     'fg=magenta'
    'globbing'                 'fg=cyan,bold'
    'assign'                   'fg=white'
    'parameter'                'fg=yellow'
    'unknown-token'            'fg=red,bold'
    'reserved-word'            'fg=magenta'
    'commandseparator'         'fg=white'
    'bracket-level-1'          'fg=blue,bold'
    'bracket-level-2'          'fg=green,bold'
    'bracket-level-3'          'fg=magenta,bold'
    'bracket-level-4'          'fg=yellow,bold'
    'bracket-error'            'fg=red,bold'
  )

  # Custom patterns for dangerous commands
  typeset -gA ZSH_HIGHLIGHT_PATTERNS=(
    'rm -rf *'                 'fg=white,bold,bg=red'
    'sudo *'                   'fg=white,bold,bg=red'
  )

  # Load zsh-syntax-highlighting from local path (managed by chezmoi)
  source ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.plugin.zsh
fi

# ----------------------------------------------------------------------------
# Local Configuration
# ----------------------------------------------------------------------------
[ -f "$XDG_CONFIG_HOME/zsh/local.zsh" ] && source "$XDG_CONFIG_HOME/zsh/local.zsh"

# ----------------------------------------------------------------------------
# Git-safe PATH modification - MUST RUN LAST
# ----------------------------------------------------------------------------
# Prepends .git/safe/../../bin to PATH for per-repository trusted binaries
# Inspired by: https://thoughtbot.com/blog/git-safe
export PATH=".git/safe/../../bin:$PATH"

# vi: ft=zsh
