#!/bin/zsh
# Periodic TruffleHog scan (runs once per day max)
# Called automatically on shell startup

# Only run if trufflehog is available
command -v trufflehog >/dev/null 2>&1 || return 0

# Skip in non-interactive shells
[[ ! -v TERM ]] && return 0

# Skip in LLM agent mode
[[ -n "${LLM_AGENT_MODE:-}" ]] && return 0

# Track last scan time
local SCAN_MARKER="$HOME/.cache/trufflehog-last-scan"
local SCAN_INTERVAL=$((24 * 60 * 60))  # 24 hours in seconds

# Create cache directory if it doesn't exist
mkdir -p "$(dirname "$SCAN_MARKER")"

# Check if scan is needed
local current_time=$(date +%s)
local last_scan=0

if [ -f "$SCAN_MARKER" ]; then
    last_scan=$(cat "$SCAN_MARKER")
fi

local time_since_scan=$((current_time - last_scan))

# Only scan if more than 24 hours have passed
if [ $time_since_scan -lt $SCAN_INTERVAL ]; then
    return 0
fi

# Run scan in background to avoid blocking shell startup
{
    echo "ðŸ” Running daily TruffleHog scan (background)..."

    # Scan home directory for secrets
    # Focus on common locations where secrets might accumulate
    local scan_paths=(
        "$HOME/.config"
        "$HOME/.ssh"
        "$HOME/.aws"
        "$HOME/.kube"
    )

    local findings=0
    for path in "${scan_paths[@]}"; do
        if [ -d "$path" ]; then
            if trufflehog filesystem "$path" \
                --no-update \
                --results=verified \
                --exclude-globs="**/.git/**" \
                --exclude-globs="**/node_modules/**" \
                --exclude-globs="**/.cache/**" \
                2>/dev/null | grep -E "Found verified result" >/dev/null; then
                findings=$((findings + 1))
                echo "âš ï¸  Verified secrets found in: $path"
            fi
        fi
    done

    if [ $findings -gt 0 ]; then
        echo "âŒ Daily scan found $findings location(s) with verified secrets"
        echo "   Run 'trufflehog filesystem ~' for full details"
    else
        echo "âœ… Daily secrets scan complete - no verified secrets found"
    fi

    # Update timestamp
    echo "$current_time" > "$SCAN_MARKER"
} &!  # Run in background, disowned from shell
