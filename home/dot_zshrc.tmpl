# ============================================================================
# Zsh Configuration
# ============================================================================

# Source zshenv again after macOS /etc/zprofile nukes PATH
source ~/.zshenv

# Stop here if this is e.g. cron or puma-dev (non-interactive)
[[ ! -v TERM ]] && return 0

# ----------------------------------------------------------------------------
# LLM Agent Detection - MUST BE EARLY
# ----------------------------------------------------------------------------
{{- if lookPath "envsense" }}
if envsense check agent >/dev/null 2>&1; then
  export LLM_AGENT_MODE=1
  [[ -f "$XDG_CONFIG_HOME/zsh/llm.zsh" ]] && source "$XDG_CONFIG_HOME/zsh/llm.zsh"
  return  # Skip all human-friendly configuration below
fi
{{- end }}

# ----------------------------------------------------------------------------
# Load Znap Plugin Manager
# ----------------------------------------------------------------------------
source ~/.zsh/znap/zsh-snap/znap.zsh

# ----------------------------------------------------------------------------
# Plugins
# ----------------------------------------------------------------------------
# Skip plugins if in LLM agent mode
if [[ -z "${SKIP_ZSH_AUTOSUGGESTIONS:-}" ]]; then
  # Pre-configure zsh-autosuggestions before loading for maximum speed
  export ZSH_AUTOSUGGEST_USE_ASYNC=1
  export ZSH_AUTOSUGGEST_MANUAL_REBIND=1
  export ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
  export ZSH_AUTOSUGGEST_HISTORY_IGNORE="?(#c50,)"  # Ignore commands > 50 chars
  export ZSH_AUTOSUGGEST_COMPLETION_IGNORE="* --help"
  export ZSH_AUTOSUGGEST_STRATEGY=(history completion)

  # Catppuccin theme support - optimized for Ghostty + tmux
  if [[ "${TERM}" == "xterm-ghostty" ]] || [[ -n "${TMUX}" ]]; then
    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=8'
  else
    export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=244'
  fi

  # Load zsh-autosuggestions via znap (downloads if needed)
  znap source zsh-users/zsh-autosuggestions

  # Speed hack: only fetch suggestions for commands > 2 chars
  _zsh_autosuggest_should_fetch() {
    (( ${#BUFFER} > 2 ))
  }
fi

# ----------------------------------------------------------------------------
# Tool Integrations
# ----------------------------------------------------------------------------
{{- if lookPath "mise" }}
# mise manages its own hooks, run directly (don't cache)
eval "$(mise activate zsh)"
{{- end }}

{{- if lookPath "atuin" }}
# atuin can be cached for faster startup
znap eval atuin 'atuin init zsh'
{{- end }}

{{- if lookPath "starship" }}
# starship can be cached for faster startup
znap eval starship 'starship init zsh'
{{- end }}

{{- if lookPath "zoxide" }}
# zoxide can be cached for faster startup
znap eval zoxide 'zoxide init zsh'
{{- end }}

# ----------------------------------------------------------------------------
# Zsh Options
# ----------------------------------------------------------------------------
# Make delete-by-word stop on punctuation like other editors
WORDCHARS=""

# Case-sensitive completion
CASE_SENSITIVE="true"

# Enable Vi mode for command line editing
bindkey -v

# Vi mode cursor changes
VI_MODE_SET_CURSOR=true

# Cursor shape support for vi mode
function zle-keymap-select {
  if [[ ${KEYMAP} == vicmd ]] || [[ $1 = 'block' ]]; then
    echo -ne '\e[1 q'  # Block cursor
  elif [[ ${KEYMAP} == main ]] || [[ ${KEYMAP} == viins ]] || [[ ${KEYMAP} = '' ]] || [[ $1 = 'beam' ]]; then
    echo -ne '\e[5 q'  # Beam cursor
  fi
}
zle -N zle-keymap-select

# Ensure beam cursor on startup
function zle-line-init {
  echo -ne '\e[5 q'
}
zle -N zle-line-init

# ----------------------------------------------------------------------------
# Completion System
# ----------------------------------------------------------------------------
# Add custom functions and completions directories to fpath
fpath=(
  "$XDG_CONFIG_HOME/zsh/functions"
  "$XDG_CONFIG_HOME/zsh/completions"
  "${fpath[@]}"
)

# Autoload custom functions
autoload -Uz c

# Initialize completion system
autoload -Uz compinit
compinit

# ----------------------------------------------------------------------------
# History Configuration
# ----------------------------------------------------------------------------
HISTFILE="${ZDOTDIR:-$HOME}/.zsh_history"
HISTSIZE=1000000000
SAVEHIST=$HISTSIZE

setopt EXTENDED_HISTORY
setopt SHARE_HISTORY
setopt APPEND_HISTORY
setopt INC_APPEND_HISTORY
setopt HIST_FIND_NO_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY

# ----------------------------------------------------------------------------
# Aliases
# ----------------------------------------------------------------------------
# Enhanced tool aliases
{{- if lookPath "bat" }}
alias cat='bat'
{{- end }}
{{- if lookPath "duf" }}
alias df='duf'
{{- end }}
{{- if lookPath "gdircolors" }}
alias dircolors='gdircolors'
{{- end }}
{{- if lookPath "dust" }}
alias du='dust'
{{- end }}
{{- if lookPath "hub" }}
alias git='hub'
{{- end }}
{{- if lookPath "eza" }}
alias ls='eza --icons=always --group-directories-first'
alias ll='eza --icons=always --long --group-directories-first'
alias la='eza --icons=always --long --all --group-directories-first'
alias tree='eza --icons=always --tree'
{{- else if lookPath "gls" }}
alias ls='gls'
{{- end }}
{{- if lookPath "colormake" }}
alias make='colormake'
{{- end }}
{{- if lookPath "htop" }}
alias top='htop'
{{- end }}
{{- if lookPath "nvim" }}
alias vi='nvim'
alias vim='nvim'
{{- else if lookPath "vim" }}
alias vi='vim'
{{- end }}

# Chezmoi shortcut
alias cz='chezmoi'

# Bundler shortcut
alias b='bundle exec'

# Colorized commands
alias grep='grep -Hn --color=auto'

# 1Password-authenticated commands
{{- if and (lookPath "op") (lookPath "codex") }}
alias codex='OPENAI_API_KEY=$(op read "op://Personal/openai-codex/credential") command codex'
{{- end }}
{{- if and (lookPath "op") (lookPath "claude") }}
alias claude-api='ANTHROPIC_API_KEY=$(op read "op://Personal/claude-code/credential") command claude'
{{- end }}

# Suffix aliases - automatically open files by extension
alias -s md="glow --pager"

# ----------------------------------------------------------------------------
# Custom Functions
# ----------------------------------------------------------------------------
# Reload shell function - re-execs the exact same zsh binary
function reload! {
  local zsh_path

  # Method 1: Linux - /proc/$$/exe symlinks to the actual executable
  if [[ -r /proc/$$/exe ]]; then
    zsh_path=$(readlink /proc/$$/exe)
  # Method 2: macOS/BSD - Use lsof to find the binary
  elif command -v lsof >/dev/null && zsh_path=$(lsof -p $$ -Fn | awk '/^n.*zsh$/{print substr($0,2); exit}'); then
    :  # zsh_path already set
  # Method 3: Non-login shells - $0 contains the actual path
  elif [[ $0 != -* ]]; then
    zsh_path=$0
  # Method 4: Login shell detection
  elif [[ $0 == -* ]]; then
    if command -v getent >/dev/null; then
      zsh_path=$(getent passwd "$USER" | cut -d: -f7)
    elif command -v dscl >/dev/null; then
      zsh_path=$(dscl . -read "/Users/$USER" UserShell | awk '{print $2}')
    else
      zsh_path=$SHELL
    fi
  # Method 5: Final fallback
  else
    zsh_path=$SHELL
  fi

  exec "$zsh_path" "$@"
}

# ----------------------------------------------------------------------------
# Zsh Syntax Highlighting (MUST BE LOADED LAST)
# ----------------------------------------------------------------------------
# Skip syntax highlighting if in LLM agent mode
if [[ -z "${SKIP_ZSH_SYNTAX_HIGHLIGHTING:-}" ]]; then
  # Configure highlighters BEFORE loading
  typeset -gA ZSH_HIGHLIGHT_HIGHLIGHTERS=(
    main 1
    brackets 1
    pattern 1
    cursor 0
    root 0
  )

  export ZSH_HIGHLIGHT_MAXLENGTH=20000

  # Catppuccin-compatible highlighting styles
  typeset -gA ZSH_HIGHLIGHT_STYLES=(
    'builtin'                  'fg=blue'
    'command'                  'fg=green'
    'precommand'               'fg=green,underline'
    'alias'                    'fg=cyan'
    'function'                 'fg=cyan'
    'path'                     'fg=white,underline'
    'path_prefix'              'fg=white'
    'path_approx'              'fg=yellow'
    'single-hyphen-option'     'fg=magenta'
    'double-hyphen-option'     'fg=magenta'
    'single-quoted-argument'   'fg=yellow'
    'double-quoted-argument'   'fg=yellow'
    'dollar-quoted-argument'   'fg=yellow'
    'back-quoted-argument'     'fg=magenta'
    'globbing'                 'fg=cyan,bold'
    'assign'                   'fg=white'
    'parameter'                'fg=yellow'
    'unknown-token'            'fg=red,bold'
    'reserved-word'            'fg=magenta'
    'commandseparator'         'fg=white'
    'bracket-level-1'          'fg=blue,bold'
    'bracket-level-2'          'fg=green,bold'
    'bracket-level-3'          'fg=magenta,bold'
    'bracket-level-4'          'fg=yellow,bold'
    'bracket-error'            'fg=red,bold'
  )

  # Custom patterns for dangerous commands
  typeset -gA ZSH_HIGHLIGHT_PATTERNS=(
    'rm -rf *'                 'fg=white,bold,bg=red'
    'sudo *'                   'fg=white,bold,bg=red'
  )

  # Load zsh-syntax-highlighting via znap (downloads if needed)
  znap source zsh-users/zsh-syntax-highlighting
fi

# ----------------------------------------------------------------------------
# Local Configuration
# ----------------------------------------------------------------------------
[ -f "$XDG_CONFIG_HOME/zsh/local.zsh" ] && source "$XDG_CONFIG_HOME/zsh/local.zsh"

# ----------------------------------------------------------------------------
# Git-safe PATH modification - MUST RUN LAST
# ----------------------------------------------------------------------------
# Prepends .git/safe/../../bin to PATH for per-repository trusted binaries
# Inspired by: https://thoughtbot.com/blog/git-safe
export PATH=".git/safe/../../bin:$PATH"

# vi: ft=zsh
